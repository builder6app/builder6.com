<!DOCTYPE html>
<html lang="en">
<head>
    {% render 'partials/head.liquid' %}
    <title>{{ project.name }} - Settings</title>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-black text-white selection:bg-blue-500 selection:text-white flex flex-col min-h-screen">

    {% render 'partials/header.liquid', is_editor: false, project: project, user: user %}
    {% render 'partials/notifications.liquid' %}

    <div class="container mx-auto px-6 py-8 max-w-2xl">
        <div class="flex items-center gap-2 mb-8 text-sm text-gray-400">
            <a href="/app/{{ project.slug | default: project._id }}" class="hover:text-white transition-colors">{{ project.name }}</a>
            <span>/</span>
            <span class="text-white">Settings</span>
        </div>

        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-bold tracking-tight">Project Settings</h2>
            <button onclick="deleteProject('{{ project._id }}')" class="text-red-400 hover:text-red-300 text-sm font-medium hover:underline transition-colors">Delete Project</button>
        </div>

        <div class="bg-[#1c1c1e] p-8 rounded-2xl border border-white/10 shadow-xl">
             <form id="projectSettingsForm" onsubmit="event.preventDefault(); updateProject();">
                <div class="mb-6">
                    <label class="block text-gray-400 text-sm font-medium mb-2">Project Name <span class="text-red-500">*</span></label>
                    <input type="text" id="editProjectName" name="name" value="{{ project.name }}" required class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors">
                    <p class="text-xs text-gray-500 mt-1">This name will be displayed in your interface.</p>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-400 text-sm font-medium mb-2">Project URL (Slug) <span class="text-red-500">*</span></label>
                    <div class="flex items-center">
                        <span class="bg-white/5 border border-r-0 border-white/10 rounded-l-lg px-3 py-2 text-gray-400 text-sm">/app/</span>
                        <input type="text" id="editProjectSlug" name="slug" value="{{ project.slug }}" required class="flex-1 bg-black/50 border border-white/10 rounded-r-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors" placeholder="project-slug">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Must be unique and URL-friendly.</p>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-400 text-sm font-medium mb-2">Home page</label>
                    <select id="editProjectHomePage" name="homePage" class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors appearance-none">
                        <option value="">Select a page...</option>
                        {% for page in pages %}
                        <option value="{{ page._id }}" {% if project.homePage == page._id %}selected{% endif %}>{{ page.name | default: "Untitled Page" }}</option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Visitors will be taken here unless navigating to a specific page.</p>
                </div>

                <div class="mb-6 flex items-center justify-between py-4 border-t border-white/5 border-b">
                    <div class="flex flex-col">
                        <span class="text-sm font-medium text-white">Display navigation on pages</span>
                        <span class="text-xs text-gray-500">You can override this setting on individual pages.</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="editProjectDisplayNavigation" name="displayNavigation" {% if project.displayNavigation %}checked{% endif %} class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-400 text-sm font-medium mb-2">Project Icon</label>
                    <div class="flex items-center gap-3">
                         <div class="w-10 h-10 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center text-xl text-white">
                            <i id="iconPreview" class="{{ project.icon | default: 'ri-building-4-line' }}"></i>
                        </div>
                        <div class="flex-1 relative">
                            <input type="text" id="editProjectIcon" name="icon" value="{{ project.icon }}" class="w-full bg-black/50 border border-white/10 rounded-lg pl-9 pr-4 py-2 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors placeholder-gray-600" placeholder="e.g. ri-home-smile-line">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">
                                <i class="ri-search-line"></i>
                            </div>
                        </div>
                        <button type="button" onclick="openIconPicker('editProjectIcon', 'iconPreview')" class="px-3 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-sm text-gray-300 transition-colors whitespace-nowrap">
                            Select Icon
                        </button>
                    </div>
                     <p class="text-xs text-gray-500 mt-1">Select an icon from the library or type a class name.</p>
                    <script>
                        document.getElementById('editProjectIcon').addEventListener('input', (e) => {
                             const icon = e.target.value.trim() || 'ri-building-4-line';
                             document.getElementById('iconPreview').className = icon;
                        });
                    </script>
                </div>

                <div class="mb-8 grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-400 text-sm font-medium mb-2">Navigation Style</label>
                        <select id="editProjectNavigationStyle" name="navigationStyle" class="w-full bg-black/50 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors appearance-none">
                            <option value="top" {% if project.navigationStyle == 'top' %}selected{% endif %}>Top Bar</option>
                            <option value="left" {% if project.navigationStyle == 'left' %}selected{% endif %}>Left Sidebar</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm font-medium mb-2">Theme Color</label>
                        <div class="flex items-center gap-2">
                            <input type="color" id="editProjectThemeColor" name="themeColor" value="{{ project.themeColor | default: '#2563eb' }}" class="h-10 w-10 rounded cursor-pointer bg-transparent border-0 p-0">
                            <input type="text" id="editProjectThemeColorText" value="{{ project.themeColor | default: '#2563eb' }}" class="flex-1 bg-black/50 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors uppercase" onchange="document.getElementById('editProjectThemeColor').value = this.value">
                        </div>
                        <script>
                            document.getElementById('editProjectThemeColor').addEventListener('input', (e) => {
                                document.getElementById('editProjectThemeColorText').value = e.target.value.toUpperCase();
                            });
                        </script>
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-6 border-t border-white/10">
                    <a href="/app/{{ project.slug | default: project._id }}" class="px-4 py-2 text-gray-400 hover:text-white transition-colors">Cancel</a>
                    <button type="submit" class="bg-[#007AFF] hover:bg-[#0062cc] text-white px-6 py-2 rounded-lg font-medium transition-colors shadow-lg shadow-blue-900/20">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% render 'partials/icon-picker.liquid' %}

    <script>
        async function updateProject() {
            const name = document.getElementById('editProjectName').value;
            const slug = document.getElementById('editProjectSlug').value;
            const homePage = document.getElementById('editProjectHomePage').value;
            const displayNavigation = document.getElementById('editProjectDisplayNavigation').checked;
            const navigationStyle = document.getElementById('editProjectNavigationStyle').value;
            const themeColor = document.getElementById('editProjectThemeColor').value;
            const icon = document.getElementById('editProjectIcon').value;
             const saveBtn = document.querySelector('button[type="submit"]');
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = 'Saving...';
            
            try {
                const response = await fetch('/api/projects/{{ project._id }}', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, slug, homePage, displayNavigation, navigationStyle, themeColor, icon }),
                });
                
                if (response.ok) {
                    window.location.href = '/app/' + (slug || '{{ project._id }}');
                } else {
                    const data = await response.json();
                    $notify(data.message || 'Failed to update project', 'error');
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = 'Save Changes';
                }
            } catch (error) {
                console.error('Error:', error);
                $notify('An error occurred', 'error');
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'Save Changes';
            }
        }

        async function deleteProject(id) {
            if (!confirm('Are you sure you want to delete this project? All pages inside it will be deleted.')) return;
            
            try {
                const response = await fetch('/api/projects/' + id, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    window.location.href = '/app';
                } else {
                    $notify('Failed to delete project', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                $notify('An error occurred', 'error');
            }
        }
    </script>
</body>
</html>